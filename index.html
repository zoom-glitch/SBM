<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>مساعد AI للمكفوفين</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
    }
    video {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: -1;
    }
    #objects {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.6);
      color: #00ff00;
      padding: 10px 15px;
      border-radius: 10px;
      font-size: 20px;
      z-index: 2;
      max-width: 90%;
      text-align: right;
    }
  </style>
</head>
<body>

  <video id="video" autoplay muted playsinline></video>
  <div id="objects">جاري التحميل...</div>

  <!-- TensorFlow -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

  <script>
    const video = document.getElementById("video");
    const objectDiv = document.getElementById("objects");
    let model;
    let lastSaid = "";

    // ✅ فتح الكاميرا الخلفية
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });
        video.srcObject = stream;
      } catch (e) {
        objectDiv.innerText = "فشل تشغيل الكاميرا";
        console.error(e);
      }
    }

    // ✅ ترجمة فورية باستخدام MyMemory API
    async function translate(text) {
      try {
        const res = await fetch(`https://api.mymemory.translated.net/get?q=${text}&langpair=en|ar`);
        const data = await res.json();
        return data.responseData.translatedText || text;
      } catch (e) {
        return text;
      }
    }

    // ✅ اختيار صوت عربي طبيعي
    function getArabicVoice() {
      const voices = window.speechSynthesis.getVoices();
      return voices.find(v => v.lang.includes("ar") && v.name.includes("Google")) ||
             voices.find(v => v.lang.includes("ar")) || null;
    }

    // ✅ نطق الكلام
    function speak(text) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'ar-EG'; // مصري إن أمكن
      msg.voice = getArabicVoice();
      msg.rate = 1;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(msg);
    }

    // ✅ التعرف على الأشياء والتحدث
    async function detectObjects() {
      const predictions = await model.detect(video);
      const rawLabels = predictions.map(p => p.class);
      const uniqueLabels = [...new Set(rawLabels)];

      if (uniqueLabels.length > 0) {
        // ترجمة كل الكائنات
        const translated = await Promise.all(uniqueLabels.map(label => translate(label)));
        const sentence = "شايف: " + translated.join("، ");
        objectDiv.innerText = sentence;

        // النطق بس لو الكلام اتغير
        if (sentence !== lastSaid) {
          lastSaid = sentence;
          speak(sentence);
        }
      } else {
        objectDiv.innerText = "مش شايف حاجة واضحة";
      }
    }

    async function init() {
      await startCamera();
      model = await cocoSsd.load();
      objectDiv.innerText = "ابدأ التعرف...";
      setInterval(detectObjects, 1000); // كل ثانية
    }

    // ضروري لتشغيل الأصوات على بعض الأجهزة
    window.addEventListener('click', () => {
      speechSynthesis.getVoices(); // تحميل الأصوات
    });

    init();
  </script>
</body>
</html>
