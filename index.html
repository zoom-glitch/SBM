<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>مساعد AI للمكفوفين</title>
  <style>
    * {
      margin: 0;
      padding: 0;
    }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
      background: black;
    }
    video {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      z-index: -1;
    }
    #objects {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.6);
      color: #00ff00;
      padding: 20px 30px;
      border-radius: 15px;
      font-size: 28px;
      text-align: center;
      max-width: 90%;
      z-index: 2;
    }
  </style>
</head>
<body>

  <video id="video" autoplay muted playsinline></video>
  <div id="objects">جاري تحميل النموذج...</div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

  <script>
    const video = document.getElementById("video");
    const objectDiv = document.getElementById("objects");
    let model;
    let lastSaid = "";

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });
        video.srcObject = stream;
      } catch (e) {
        objectDiv.innerText = "فشل تشغيل الكاميرا";
        console.error(e);
      }
    }

    async function translate(text) {
      try {
        const res = await fetch(`https://api.mymemory.translated.net/get?q=${text}&langpair=en|ar`);
        const data = await res.json();
        return data.responseData.translatedText || text;
      } catch (e) {
        return text;
      }
    }

    function getArabicVoice() {
      const voices = window.speechSynthesis.getVoices();
      return voices.find(v => v.lang.includes("ar") && v.name.includes("Google")) ||
             voices.find(v => v.lang.includes("ar")) || null;
    }

    function speak(text) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'ar-EG';
      msg.voice = getArabicVoice();
      msg.rate = 0.85; // نطق أبطأ شويه
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(msg);
    }

    async function detectObjects() {
      const predictions = await model.detect(video);
      const rawLabels = predictions.map(p => p.class);
      const uniqueLabels = [...new Set(rawLabels)];

      if (uniqueLabels.length > 0) {
        const translated = await Promise.all(uniqueLabels.map(label => translate(label)));
        const description = "قدامك: " + translated.join("، ");
        objectDiv.innerText = description;

        if (description !== lastSaid) {
          lastSaid = description;
          speak(description);
        }
      } else {
        objectDiv.innerText = "مش شايف حاجة واضحة";
      }
    }

    async function init() {
      await startCamera();
      model = await cocoSsd.load();
      objectDiv.innerText = "ابدأ التعرف...";
      setInterval(detectObjects, 4000); // كل 4 ثواني
    }

    window.addEventListener('click', () => {
      speechSynthesis.getVoices(); // لتفعيل الأصوات على بعض الأجهزة
    });

    init();
  </script>
</body>
</html>
